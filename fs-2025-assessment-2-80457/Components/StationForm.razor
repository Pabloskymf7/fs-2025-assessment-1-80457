@using fs_2025_assessment_1_80457.Models
@using System.ComponentModel.DataAnnotations
@using fs_2025_assessment_2_80457.Services
@inject IStationsApiClient ApiClient

@code {
    // Clase de modelo para el formulario
    public class StationFormModel
    {
        // Campos requeridos y con validación mínima
        [Required(ErrorMessage = "El nombre es obligatorio.")]
        [StringLength(100, ErrorMessage = "El nombre no puede exceder los 100 caracteres.")]
        public string? Name { get; set; }

        [Required(ErrorMessage = "La dirección es obligatoria.")]
        public string? Address { get; set; }

        [Required(ErrorMessage = "El número es obligatorio.")]
        [Range(1, 9999, ErrorMessage = "El número de estación debe ser positivo.")]
        public int? Number { get; set; }

        [Required(ErrorMessage = "Los puestos totales son obligatorios.")]
        [Range(1, 200, ErrorMessage = "Los puestos deben estar entre 1 y 200.")]
        public int BikeStands { get; set; }

        // Mapea la capacidad real (ej: 50)
        public int AvailableBikeStands { get; set; }

        [Range(0, 200, ErrorMessage = "Las bicicletas disponibles no pueden ser negativas.")]
        public int AvailableBikes { get; set; }

        // Valor que debe ser "OPEN" o "CLOSED"
        [Required(ErrorMessage = "El estado es obligatorio.")]
        public string? Status { get; set; } = "OPEN";

        // Lat/Lng
        [Range(-90.0, 90.0, ErrorMessage = "Latitud inválida.")]
        public double? Lat { get; set; }

        [Range(-180.0, 180.0, ErrorMessage = "Longitud inválida.")]
        public double? Lng { get; set; }

        // Propiedad para diferenciar entre Crear y Editar
        public bool IsNew => OriginalStationId == null;
        public string? OriginalStationId { get; set; }
    }
}

<div class="card p-4 shadow">
    <h4>@(Model.IsNew ? "Crear Nueva Estación" : $"Editar Estación {Model.Number}")</h4>

    <EditForm Model="Model" OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit" FormName="StationEditForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row mb-3">
            <div class="col-md-8">
                <label for="name" class="form-label">Nombre de la Estación</label>
                <InputText id="name" class="form-control" @bind-Value="Model.Name" />
                <ValidationMessage For="@(() => Model.Name)" />
            </div>
            <div class="col-md-4">
                <label for="number" class="form-label">Número de Estación</label>
                <InputNumber id="number" class="form-control" @bind-Value="Model.Number" readonly="@(!Model.IsNew)" />
                <ValidationMessage For="@(() => Model.Number)" />
            </div>
        </div>

        <div class="mb-3">
            <label for="address" class="form-label">Dirección</label>
            <InputText id="address" class="form-control" @bind-Value="Model.Address" />
            <ValidationMessage For="@(() => Model.Address)" />
        </div>

        <div class="mb-3">
            <label for="status" class="form-label">Estado</label>
            <InputSelect id="status" class="form-select" @bind-Value="Model.Status">
                <option value="OPEN">Abierto</option>
                <option value="CLOSED">Cerrado</option>
            </InputSelect>
            <ValidationMessage For="@(() => Model.Status)" />
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="bikeStands" class="form-label">Puestos Totales (bike_stands)</label>
                <InputNumber id="bikeStands" class="form-control" @bind-Value="Model.BikeStands" />
                <ValidationMessage For="@(() => Model.BikeStands)" />
            </div>
            <div class="col-md-6">
                <label for="availableBikes" class="form-label">Bicicletas Disponibles</label>
                <InputNumber id="availableBikes" class="form-control" @bind-Value="Model.AvailableBikes" />
                <ValidationMessage For="@(() => Model.AvailableBikes)" />
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="lat" class="form-label">Latitud</label>
                <InputNumber id="lat" class="form-control" @bind-Value="Model.Lat" step="0.000001" />
                <ValidationMessage For="@(() => Model.Lat)" />
            </div>
            <div class="col-md-6">
                <label for="lng" class="form-label">Longitud</label>
                <InputNumber id="lng" class="form-control" @bind-Value="Model.Lng" step="0.000001" />
                <ValidationMessage For="@(() => Model.Lng)" />
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-success">
                @(Model.IsNew ? "Crear Estación" : "Guardar Cambios")
            </button>
            <button type="button" class="btn btn-secondary" @onclick="HandleCancelClick">
                Cancelar
            </button>
        </div>
    </EditForm>

    @if (!string.IsNullOrEmpty(feedbackMessage))
    {
        <div class="alert @feedbackCssClass mt-3" role="alert">
            @feedbackMessage
        </div>
    }
</div>


@code {
    // Parámetro para pasar el modelo de datos (puede ser una estación existente o nueva)
    [Parameter]
    public StationFormModel Model { get; set; } = new StationFormModel();

    // Evento para notificar al padre cuando el formulario se ha completado/cancelado.
    [Parameter]
    public EventCallback OnSubmitted { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private string? feedbackMessage;
    private string feedbackCssClass = "alert-info";

    // Manejador si la validación del formulario NO ES exitosa.
    private void HandleInvalidSubmit()
    {
        // 🚨🚨🚨 PUNTO DE INTERRUPCIÓN PARA FALLOS DE VALIDACIÓN 🚨🚨🚨
        feedbackMessage = "❌ Por favor, corrige los errores de validación del formulario.";
        feedbackCssClass = "alert-danger";
    }

    // Manejador para el botón de Cancelar
    private async Task HandleCancelClick()
    {
        await OnCancel.InvokeAsync();
    }


    // Maneja la sumisión del formulario cuando la validación es exitosa.
    private async Task HandleValidSubmit()
    {
        feedbackMessage = "Enviando datos a la API...";
        feedbackCssClass = "alert-info";

        // Mapear el modelo de la forma a la clase Bike
        var bikeToSubmit = new Bike
        {
            id = Model.OriginalStationId, // Usar el ID original para PUT
            number = Model.Number!.Value,
            name = Model.Name,
            address = Model.Address,
            status = Model.Status,
            bike_stands = Model.BikeStands, // La capacidad total
            available_bikes = Model.AvailableBikes,
            // Las bike_stands disponibles es la diferencia entre la capacidad total y las bicis.
            available_bike_stands = Model.BikeStands - Model.AvailableBikes,
            last_update_epoch = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds(), // Actualizar la marca de tiempo
            contract_name = "Dublin", // Suponemos el contrato para nuevas estaciones
            banking = false,
            bonus = false,
            position = new Position { Lat = Model.Lat ?? 0, Lng = Model.Lng ?? 0 }
        };

        try
        {
            if (Model.IsNew)
            {
                // POST: Crear nuevo registro
                await ApiClient.CreateStationAsync(bikeToSubmit);
                feedbackMessage = "✅ Estación creada exitosamente.";
                feedbackCssClass = "alert-success";
            }
            else
            {
                // PUT: Actualizar registro existente
                await ApiClient.UpdateStationAsync(bikeToSubmit.number, bikeToSubmit);
                feedbackMessage = "✅ Estación actualizada exitosamente.";
                feedbackCssClass = "alert-success";
            }

            // Notificar al componente padre
            await OnSubmitted.InvokeAsync();
        }
        catch (HttpRequestException ex)
        {
            // 🚨🚨🚨 PUNTO DE INTERRUPCIÓN PARA FALLOS DE API 🚨🚨🚨
            // Manejo de errores de la API (ej: 404, 400)
            feedbackMessage = $"❌ Error de API: {ex.Message}";
            feedbackCssClass = "alert-danger";
        }
        catch (Exception ex)
        {
            feedbackMessage = $"❌ Error inesperado: {ex.Message}";
            feedbackCssClass = "alert-danger";
        }
    }
}