@using Humanizer
@using System.Globalization
@using fs_2025_assessment_1_80457.Models

@if (Station != null)
{
	<div class="card bg-light mt-4 shadow-sm">
		<div class="card-header d-flex justify-content-between align-items-center">
			<h3 class="mb-0">Station Detail: @Station.name</h3>
			<button type="button" class="btn-close" aria-label="Close" @onclick="OnClose"></button>
		</div>
		<div class="card-body">
			<dl class="row">
				<dt class="col-sm-3">Address</dt>
				<dd class="col-sm-9">@Station.address</dd>

				<dt class="col-sm-3">Status</dt>
				<dd class="col-sm-9">
					<span class="badge @(Station.status == "OPEN" ? "bg-success" : "bg-danger")">
						@Station.status
					</span>
				</dd>

				<dt class="col-sm-3">Total Capacity</dt>
				<dd class="col-sm-9">@(Station.bike_stands + Station.available_bike_stands)</dd>

				<dt class="col-sm-3">Available Bikes</dt>
				<dd class="col-sm-9">@Station.available_bikes</dd>

				<dt class="col-sm-3">Available Stands</dt>
				<dd class="col-sm-9">@Station.available_bike_stands</dd>

				<dt class="col-sm-3">Last Update</dt>
				<dd class="col-sm-9">
					@Station.LastUpdateLocal.ToString("g")
					(@TimeSpan.FromSeconds((DateTimeOffset.Now - Station.LastUpdateLocal).TotalSeconds).Humanize(culture: new CultureInfo("en-US")) ago)
				</dd>

				<dt class="col-sm-3">Coordinates</dt>
				<dd class="col-sm-9">
					@if (Station.position != null)
					{
						var linkUrl = $"https://www.google.com/maps/search/?api=1&query={Station.position.Lat},{Station.position.Lng}";
						<a href="@linkUrl" target="_blank" rel="noopener noreferrer">
							Lat: @Station.position.Lat, Lng: @Station.position.Lng
						</a>
					}
					else
					{
						<span>N/A</span>
					}
				</dd>
			</dl>

			<h4 class="mt-4">Occupancy</h4>
			@{
				// Calculates the occupancy percentage (available bikes)
				int occupancyPercent = (int)Math.Round(Station.Occupancy * 100);
				string progressClass = occupancyPercent > 75 ? "bg-danger" :
				occupancyPercent > 50 ? "bg-warning text-dark" :
				"bg-success";
			}
			<div class="progress" role="progressbar" aria-label="Station Occupancy"
				          aria-valuenow="@occupancyPercent" aria-valuemin="0" aria-valuemax="100">
				<div class="progress-bar @progressClass" style="width: @occupancyPercent%">
					@(occupancyPercent)% Full
				</div>
			</div>
			<small class="text-muted" aria-hidden="true">
				@Station.available_bikes out of @(Station.bike_stands + Station.available_bike_stands) spaces occupied.
			</small>

		</div>
	</div>
}

@code {
	// Parameter for the station to be displayed
	[Parameter]
	public Bike? Station { get; set; }

	// EventCallback to notify the main page when the detail should be closed
	[Parameter]
	public EventCallback OnClose { get; set; }

}